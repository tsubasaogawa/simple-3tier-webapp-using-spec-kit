# 機能仕様: AWS 3層Webアプリケーション基盤の構築

**機能ブランチ**: `001-aws-3tier-webapp`  
**作成日**: 2025-10-29  
**ステータス**: ドラフト  
**入力**: ユーザー記述: "AWS を用いた 3 層構造の web アプリケーションを構築したい。フロントは API Gateway, バックエンドは ECS Fargate, データベースは DynamoDB とする。アプリケーションの処理はシンプルな todo アプリとする (要件は問わない)。IaC として Terraform を利用し、ECS については terraform-aws-modules/ecs を利用すること。"

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - IaCによるインフラ払い出し (優先度: P1)

開発者として、`terraform apply` コマンド一発でAWSのインフラ全体をプロビジョニングしたい。これにより、開発・ステージング・本番環境を迅速かつ一貫性を持って構築できる。

**この優先度の理由**: 機能の根幹であり、すべての開発作業の前提となるため。

**独立したテスト**: `terraform apply` を実行し、AWSコンソール上で全てのインフラ（VPC, API Gateway, ECS, DynamoDBなど）が正しく作成されていることを確認することでテスト可能。

**受け入れシナリオ**:

1. **前提**: AWS認証情報が設定済みである。 **操作**: `terraform apply` を実行する。 **結果**: エラーなく完了し、AWS上に3層アーキテクチャのインフラが構築される。
2. **前提**: インフラが構築済みである。 **操作**: `terraform destroy` を実行する。 **結果**: 作成されたすべてのリソースが削除される。

---

### ユーザーストーリー 2 - コンテナアプリケーションのデプロイ (優先度: P2)

開発者として、コンテナ化されたTodoアプリケーションをECS Fargateクラスタにデプロイしたい。これにより、API Gateway経由でアプリケーションが公開され、利用可能になる。

**この優先度の理由**: インフラが価値を生むためには、アプリケーションが動作する必要があるため。

**独立したテスト**: サンプルのコンテナイメージをECSにデプロイし、API GatewayからHTTPリクエストを送信して、正常なレスポンスが返ることを確認することでテスト可能。

**受け入れシナリオ**:

1. **前提**: ECSクラスタとサービスが稼働している。 **操作**: 新しいコンテナイメージをデプロイする。 **結果**: 新しいバージョンのアプリケーションがダウンタイムなくリリースされ、API Gateway経由でアクセスできる。

---

### ユーザーストーリー 3 - 負荷に応じた自動スケーリング (優先度: P3)

システムとして、CPUやメモリの負荷に応じてECSタスクの数を自動的に増減させたい。これにより、トラフィックの増減に柔軟に対応し、コストとパフォーマンスのバランスを最適化する。

**この優先度の理由**: サービスの可用性とコスト効率を担保するため。

**独立したテスト**: 負荷テストツールを使い、ECSサービスに高い負荷をかける。CloudWatchメトリクスでCPU使用率の上昇と、それに伴うタスク数の増加を確認することでテスト可能。

**受け入れシナリオ**:

1. **前提**: ECSサービスのCPU使用率が75%未満である。 **操作**: サービスのCPU使用率が継続的に75%を超える。 **結果**: ECSタスクの数が自動的に増加する。
2. **前提**: ECSタスクが増加している状態である。 **操作**: サービスのCPU使用率が継続的に25%を下回る。 **結果**: ECSタスクの数が自動的に減少する。

---

### エッジケース

- プロビジョニング中にAWSのAPIが一時的に失敗した場合、Terraformはリトライするか、安全に停止するか。
- DynamoDBのプロビジョニング済みキャパシティを超えたリクエストがあった場合に、アプリケーションはどのように応答するか。

## 要件 *(必須)*

### 機能要件

- **FR-001**: インフラ全体がTerraformを使用してコードとして定義されなければならない。
- **FR-002**: インフラは、API Gateway (フロントエンド)、ECS Fargate (バックエンド)、DynamoDB (データベース) の3層構造で構成されなければならない。
- **FR-003**: ECS Fargateクラスタの構成には、`terraform-aws-modules/ecs` モジュールを利用しなければならない。
- **FR-004**: API Gatewayは、受け取ったHTTPリクエストをECS Fargateサービスにルーティングしなければならない。
- **FR-005**: ECSタスクは、DynamoDBテーブルへの読み書きを行うための適切なIAM権限を持たなければならない。
- **FR-006**: ECSサービスは、CPU使用率などのメトリクスに基づいてタスク数を自動でスケーリングするよう設定されなければならない。
- **FR-007**: DynamoDBテーブルは、Todoアプリケーションのデータモデルに適したプライマリキー（例: `id`）で構成されなければならない。

### 主要エンティティ *(データが関わる場合に含める)*

- **TodoItem**: 一つのTodoタスクを表す。
  - **属性**: `id` (文字列, パーティションキー), `task` (文字列), `status` (文字列, 例: "todo", "in-progress", "done"), `createdAt` (文字列, ISO 8601形式)

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: 開発者は、`terraform apply` を一度実行するだけで、15分以内にすべてのインフラストラクチャをゼロから正常にプロビジョニングできる。
- **SC-002**: デプロイされたTodoアプリケーションは、API Gatewayのエンドポイントを通じて、DynamoDBテーブルに対するCRUD（作成、読み取り、更新、削除）操作を1秒以内に完了できる。
- **SC-003**: ECSサービスの平均CPU使用率が1分間75%を超えた場合、5分以内に新しいECSタスクが起動し、負荷分散される。
- **SC-004**: インフラの月額費用は、$50未満に収まるように設計する。