# 調査記録: AWS 3層Webアプリケーション基盤

**目的**: 実装計画の未確定要素を解決し、技術的な意思決定を行う。

## 1. Todoアプリケーションの技術スタック

### 課題

機能仕様書では、インフラの動作検証用にシンプルなTodoアプリケーションをデプロイすることが求められていますが、その言語やフレームワークは指定されていませんでした。

### 決定

- **言語**: Python 3.11
- **フレームワーク**: FastAPI

### 根拠

- **迅速な開発**: FastAPIは、最小限のコードで高性能なREST APIを構築できるため、インフラの検証用アプリケーションとして迅速に開発できます。
- **自動ドキュメント生成**: OpenAPI (Swagger UI) と ReDoc のドキュメントが自動で生成されるため、APIの動作確認やテストが容易になります。
- **コンテナとの親和性**: PythonとFastAPIは軽量なコンテナイメージを作成しやすく、AWS ECS Fargateでの実行に適しています。
- **エコシステム**: PythonはAWS SDK (Boto3) との連携がスムーズであり、将来的な拡張も容易です。

## 2. ネットワークアーキテクチャ

### 課題

VPC、サブネット、およびAPI GatewayとECS Fargate間の通信方法など、詳細なネットワーク構成が定義されていませんでした。特に、月額$50未満という厳しいコスト制約と、構成のシンプルさが最優先事項でした。

### 決定

- **VPC構成**: 単一の**パブリックサブネット**のみを持つVPCを構築します。
- **リソース配置**: ECS Fargateタスクはパブリックサブネットに配置し、パブリックIPアドレスを割り当てます。
- **サービスディスカバリ**: **AWS Cloud Map** を利用して、ECSタスクのプライベートIPアドレスをサービスとして登録・管理します。
- **API Gateway連携**: API Gatewayは **VPCリンク** を通じて、AWS Cloud Mapに登録されたサービスディスカバリ名をターゲットとします。これにより、ロードバランサーを介さずに直接ECSタスクと通信します。
- **セキュリティ**: ECSタスクのセキュリティグループを厳格に設定し、API GatewayのVPCリンクからのトラフィックのみを許可することで、インターネットからの直接アクセスをブロックします。

### 根拠

- **コストの絶対的最小化**: この構成では、NATゲートウェイ、ロードバランサー（ALB/NLB）、VPCエンドポイントといった、継続的なコストが発生するコンポーネントをすべて排除できます。これにより、コンピューティング（Fargate）とストレージ（DynamoDB）以外のインフラコストをほぼゼロに近づけ、月額$50未満の予算要件を確実に満たします。これはユーザーからの明確な指示によるものです。
- **究極のシンプルさ**: ネットワーク構成が単一のパブリックサブネットで完結し、中間コンポーネントが一切ないため、最もシンプルで理解しやすいアーキテクチャです。

### 検討された代替案

- **プライベートサブネット + VPCエンドポイント**: セキュリティ的にはより堅牢な構成ですが、VPCエンドポイントのわずかなコストも削減したいというユーザーの意向により、採用しませんでした。これがベストプラクティスに近い構成です。
- **Network Load Balancer (NLB)**: VPCリンクのターゲットとして利用可能ですが、月額$16程度の固定費が発生するため却下されました。
- **NATゲートウェイ**: プライベートサブネットからのアウトバウンド通信を容易に実現できますが、コストが予算を超過するため採用しませんでした。
